{
  if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
    return null;
  }
  final List<String> allGeocodes=new ArrayList<String>(Arrays.asList(geocodes));
  setMessage(cgeoapplication.getInstance().getResources().getQuantityString(R.plurals.cache_counts,allGeocodes.size(),allGeocodes.size()));
  final SimpleDateFormat fileNameDateFormat=new SimpleDateFormat("yyyyMMddHHmmss",Locale.US);
  final File exportFile=new File(Settings.getGpxExportDir() + File.separatorChar + "export_"+ fileNameDateFormat.format(new Date())+ ".gpx");
  BufferedWriter writer=null;
  try {
    final File exportLocation=new File(Settings.getGpxExportDir());
    exportLocation.mkdirs();
    writer=new BufferedWriter(new FileWriter(exportFile));
    new GpxSerializer().writeGPX(allGeocodes,writer,new GpxSerializer.ProgressListener(){
      @Override public void publishProgress(      int countExported){
        this.publishProgress(countExported);
      }
    }
);
  }
 catch (  final Exception e) {
    Log.e("GpxExport.ExportTask export",e);
    if (writer != null) {
      try {
        writer.close();
      }
 catch (      final IOException e1) {
      }
    }
    if (exportFile.exists()) {
      exportFile.delete();
    }
    return null;
  }
  return exportFile;
}
