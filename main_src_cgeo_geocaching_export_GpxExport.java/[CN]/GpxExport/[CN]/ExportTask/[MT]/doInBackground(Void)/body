{
  if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
    return null;
  }
  final SimpleDateFormat fileNameDateFormat=new SimpleDateFormat("yyyyMMddHHmmss",Locale.US);
  final File exportFile=new File(Settings.getGpxExportDir() + File.separatorChar + "export_"+ fileNameDateFormat.format(new Date())+ ".gpx");
  FileWriter writer=null;
  try {
    final File exportLocation=new File(Settings.getGpxExportDir());
    exportLocation.mkdirs();
    final XmlSerializer gpx=Xml.newSerializer();
    writer=new FileWriter(exportFile);
    gpx.setOutput(writer);
    gpx.startDocument("UTF-8",true);
    gpx.setPrefix("",PREFIX_GPX);
    gpx.setPrefix("xsi",PREFIX_XSI);
    gpx.setPrefix("groundspeak",PREFIX_GROUNDSPEAK);
    gpx.startTag(PREFIX_GPX,"gpx");
    gpx.attribute("","version","1.0");
    gpx.attribute("","creator","c:geo - http://www.cgeo.org/");
    gpx.attribute(PREFIX_XSI,"schemaLocation",PREFIX_GPX + " http://www.topografix.com/GPX/1/0/gpx.xsd " + PREFIX_GROUNDSPEAK+ " http://www.groundspeak.com/cache/1/0/1/cache.xsd");
    while (!allGeocodes.isEmpty()) {
      final List<String> batch=allGeocodes.subList(0,Math.min(CACHES_PER_BATCH,allGeocodes.size()));
      exportBatch(gpx,batch);
      batch.clear();
    }
    gpx.endTag(PREFIX_GPX,"gpx");
    gpx.endDocument();
  }
 catch (  final Exception e) {
    Log.e("GpxExport.ExportTask export",e);
    if (writer != null) {
      try {
        writer.close();
      }
 catch (      IOException e1) {
      }
    }
    if (exportFile.exists()) {
      exportFile.delete();
    }
    return null;
  }
  return exportFile;
}
