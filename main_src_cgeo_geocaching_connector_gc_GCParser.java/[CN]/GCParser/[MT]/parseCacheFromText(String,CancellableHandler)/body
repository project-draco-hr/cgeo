{
  CancellableHandler.sendLoadProgressDetail(handler,R.string.cache_dialog_loading_details_status_details);
  if (StringUtils.isBlank(pageIn)) {
    Log.e("GCParser.parseCache: No page given");
    return null;
  }
  if (pageIn.contains(GCConstants.STRING_UNPUBLISHED_OTHER) || pageIn.contains(GCConstants.STRING_UNPUBLISHED_FROM_SEARCH)) {
    return ImmutablePair.of(StatusCode.UNPUBLISHED_CACHE,null);
  }
  if (pageIn.contains(GCConstants.STRING_PREMIUMONLY_1) || pageIn.contains(GCConstants.STRING_PREMIUMONLY_2)) {
    return ImmutablePair.of(StatusCode.PREMIUM_ONLY,null);
  }
  final String cacheName=Html.fromHtml(TextUtils.getMatch(pageIn,GCConstants.PATTERN_NAME,true,"")).toString();
  if (GCConstants.STRING_UNKNOWN_ERROR.equalsIgnoreCase(cacheName)) {
    return ImmutablePair.of(StatusCode.UNKNOWN_ERROR,null);
  }
  String personalNoteWithLineBreaks="";
  final MatcherWrapper matcher=new MatcherWrapper(GCConstants.PATTERN_PERSONALNOTE,pageIn);
  if (matcher.find()) {
    personalNoteWithLineBreaks=matcher.group(1).trim();
  }
  final String page=TextUtils.replaceWhitespace(pageIn);
  final Geocache cache=new Geocache();
  cache.setDisabled(page.contains(GCConstants.STRING_DISABLED));
  cache.setArchived(page.contains(GCConstants.STRING_ARCHIVED));
  cache.setPremiumMembersOnly(TextUtils.matches(page,GCConstants.PATTERN_PREMIUMMEMBERS));
  cache.setFavorite(TextUtils.matches(page,GCConstants.PATTERN_FAVORITE));
  cache.setGeocode(TextUtils.getMatch(page,GCConstants.PATTERN_GEOCODE,true,cache.getGeocode()));
  cache.setCacheId(TextUtils.getMatch(page,GCConstants.PATTERN_CACHEID,true,cache.getCacheId()));
  cache.setGuid(TextUtils.getMatch(page,GCConstants.PATTERN_GUID,true,cache.getGuid()));
  cache.setName(cacheName);
  cache.setOwnerUserId(Network.decode(TextUtils.getMatch(page,GCConstants.PATTERN_OWNER_USERID,true,cache.getOwnerUserId())));
  cache.setUserModifiedCoords(false);
  String tableInside=page;
  final int pos=tableInside.indexOf(GCConstants.STRING_CACHEDETAILS);
  if (pos == -1) {
    Log.e("GCParser.parseCache: ID \"cacheDetails\" not found on page");
    return null;
  }
  tableInside=tableInside.substring(pos);
  if (StringUtils.isNotBlank(tableInside)) {
    String result=TextUtils.getMatch(tableInside,GCConstants.PATTERN_TERRAIN,true,null);
    if (result != null) {
      try {
        cache.setTerrain(Float.parseFloat(StringUtils.replaceChars(result,'_','.')));
      }
 catch (      final NumberFormatException e) {
        Log.e("Error parsing terrain value",e);
      }
    }
    result=TextUtils.getMatch(tableInside,GCConstants.PATTERN_DIFFICULTY,true,null);
    if (result != null) {
      try {
        cache.setDifficulty(Float.parseFloat(StringUtils.replaceChars(result,'_','.')));
      }
 catch (      final NumberFormatException e) {
        Log.e("Error parsing difficulty value",e);
      }
    }
    cache.setOwnerDisplayName(StringEscapeUtils.unescapeHtml4(TextUtils.getMatch(tableInside,GCConstants.PATTERN_OWNER_DISPLAYNAME,true,cache.getOwnerDisplayName())));
    try {
      String hiddenString=TextUtils.getMatch(tableInside,GCConstants.PATTERN_HIDDEN,true,null);
      if (StringUtils.isNotBlank(hiddenString)) {
        cache.setHidden(GCLogin.parseGcCustomDate(hiddenString));
      }
      if (cache.getHiddenDate() == null) {
        hiddenString=TextUtils.getMatch(tableInside,GCConstants.PATTERN_HIDDENEVENT,true,null);
        if (StringUtils.isNotBlank(hiddenString)) {
          cache.setHidden(GCLogin.parseGcCustomDate(hiddenString));
        }
      }
    }
 catch (    final ParseException e) {
      Log.w("GCParser.parseCache: Failed to parse cache hidden (event) date");
    }
    try {
      cache.setFavoritePoints(Integer.parseInt(TextUtils.getMatch(tableInside,GCConstants.PATTERN_FAVORITECOUNT,true,"0")));
    }
 catch (    final NumberFormatException e) {
      Log.e("Error parsing favorite count",e);
    }
    cache.setSize(CacheSize.getById(TextUtils.getMatch(tableInside,GCConstants.PATTERN_SIZE,true,CacheSize.NOT_CHOSEN.id)));
  }
  cache.setFound(TextUtils.matches(page,GCConstants.PATTERN_FOUND) || TextUtils.matches(page,GCConstants.PATTERN_FOUND_ALTERNATIVE));
  cache.setType(CacheType.getByGuid(TextUtils.getMatch(page,GCConstants.PATTERN_TYPE,true,cache.getType().id)));
  cache.setOnWatchlist(TextUtils.matches(page,GCConstants.PATTERN_WATCHLIST));
  String latlon=TextUtils.getMatch(page,GCConstants.PATTERN_LATLON,true,"");
  if (StringUtils.isNotEmpty(latlon)) {
    try {
      cache.setCoords(new Geopoint(latlon));
      cache.setReliableLatLon(true);
    }
 catch (    final Geopoint.GeopointException e) {
      Log.w("GCParser.parseCache: Failed to parse cache coordinates",e);
    }
  }
  cache.setLocation(TextUtils.getMatch(page,GCConstants.PATTERN_LOCATION,true,""));
  final String result=TextUtils.getMatch(page,GCConstants.PATTERN_HINT,false,null);
  if (result != null) {
    final String hint=GCConstants.PATTERN_LINEBREAK.matcher(result).replaceAll("\n");
    cache.setHint(StringUtils.replace(hint,"</p>","").trim());
  }
  cache.checkFields();
  cache.setPersonalNote(personalNoteWithLineBreaks);
  cache.setShortDescription(TextUtils.getMatch(page,GCConstants.PATTERN_SHORTDESC,true,""));
  final String longDescription=TextUtils.getMatch(page,GCConstants.PATTERN_DESC,true,"");
  String relatedWebPage=TextUtils.getMatch(page,GCConstants.PATTERN_RELATED_WEB_PAGE,true,"");
  if (StringUtils.isNotEmpty(relatedWebPage)) {
    relatedWebPage=String.format("<a href=\"%s\"><b>%s</b></a><br/><br/>",relatedWebPage,relatedWebPage);
  }
  cache.setDescription(relatedWebPage + longDescription);
  try {
    final String attributesPre=TextUtils.getMatch(page,GCConstants.PATTERN_ATTRIBUTES,true,null);
    if (null != attributesPre) {
      final MatcherWrapper matcherAttributesInside=new MatcherWrapper(GCConstants.PATTERN_ATTRIBUTESINSIDE,attributesPre);
      final ArrayList<String> attributes=new ArrayList<>();
      while (matcherAttributesInside.find()) {
        if (matcherAttributesInside.groupCount() > 1 && !matcherAttributesInside.group(2).equalsIgnoreCase("blank")) {
          String attribute=matcherAttributesInside.group(2).toLowerCase(Locale.US);
          final String imageName=matcherAttributesInside.group(1).trim();
          if (StringUtils.isNotEmpty(imageName)) {
            final int start=imageName.lastIndexOf('/');
            final int end=imageName.lastIndexOf('.');
            if (start >= 0 && end >= 0) {
              attribute=imageName.substring(start + 1,end).replace('-','_').toLowerCase(Locale.US);
            }
          }
          attributes.add(attribute);
        }
      }
      cache.setAttributes(attributes);
    }
  }
 catch (  final RuntimeException e) {
    Log.w("GCParser.parseCache: Failed to parse cache attributes");
  }
  try {
    if (CancellableHandler.isCancelled(handler)) {
      return null;
    }
    CancellableHandler.sendLoadProgressDetail(handler,R.string.cache_dialog_loading_details_status_spoilers);
    final MatcherWrapper matcherSpoilersInside=new MatcherWrapper(GCConstants.PATTERN_SPOILER_IMAGE,page);
    while (matcherSpoilersInside.find()) {
      final String url=matcherSpoilersInside.group(1).replace("/display","");
      String title=null;
      if (matcherSpoilersInside.group(3) != null) {
        title=matcherSpoilersInside.group(3);
      }
      String description=null;
      if (matcherSpoilersInside.group(4) != null) {
        description=matcherSpoilersInside.group(4);
      }
      cache.addSpoiler(new Image(url,title,description));
    }
  }
 catch (  final RuntimeException e) {
    Log.w("GCParser.parseCache: Failed to parse cache spoilers");
  }
  try {
    cache.setInventoryItems(0);
    final MatcherWrapper matcherInventory=new MatcherWrapper(GCConstants.PATTERN_INVENTORY,page);
    if (matcherInventory.find()) {
      if (cache.getInventory() == null) {
        cache.setInventory(new ArrayList<Trackable>());
      }
      if (matcherInventory.groupCount() > 1) {
        final String inventoryPre=matcherInventory.group(2);
        if (StringUtils.isNotBlank(inventoryPre)) {
          final MatcherWrapper matcherInventoryInside=new MatcherWrapper(GCConstants.PATTERN_INVENTORYINSIDE,inventoryPre);
          while (matcherInventoryInside.find()) {
            if (matcherInventoryInside.groupCount() > 0) {
              final Trackable inventoryItem=new Trackable();
              inventoryItem.setGuid(matcherInventoryInside.group(1));
              inventoryItem.setName(matcherInventoryInside.group(2));
              cache.getInventory().add(inventoryItem);
              cache.setInventoryItems(cache.getInventoryItems() + 1);
            }
          }
        }
      }
    }
  }
 catch (  final RuntimeException e) {
    Log.w("GCParser.parseCache: Failed to parse cache inventory (2)");
  }
  try {
    final String countlogs=TextUtils.getMatch(page,GCConstants.PATTERN_COUNTLOGS,true,null);
    if (null != countlogs) {
      final MatcherWrapper matcherLog=new MatcherWrapper(GCConstants.PATTERN_COUNTLOG,countlogs);
      while (matcherLog.find()) {
        final String typeStr=matcherLog.group(1);
        final String countStr=getNumberString(matcherLog.group(2));
        if (StringUtils.isNotBlank(typeStr) && LogType.UNKNOWN != LogType.getByIconName(typeStr) && StringUtils.isNotBlank(countStr)) {
          cache.getLogCounts().put(LogType.getByIconName(typeStr),Integer.parseInt(countStr));
        }
      }
    }
  }
 catch (  final NumberFormatException e) {
    Log.w("GCParser.parseCache: Failed to parse cache log count");
  }
  cache.setWaypoints(Collections.<Waypoint>emptyList(),false);
  try {
    final String originalCoords=TextUtils.getMatch(page,GCConstants.PATTERN_LATLON_ORIG,false,null);
    if (null != originalCoords) {
      final Waypoint waypoint=new Waypoint(CgeoApplication.getInstance().getString(R.string.cache_coordinates_original),WaypointType.ORIGINAL,false);
      waypoint.setCoords(new Geopoint(originalCoords));
      cache.addOrChangeWaypoint(waypoint,false);
      cache.setUserModifiedCoords(true);
    }
  }
 catch (  final Geopoint.GeopointException e) {
  }
  int wpBegin=page.indexOf("<table class=\"Table\" id=\"ctl00_ContentBody_Waypoints\">");
  if (wpBegin != -1) {
    if (CancellableHandler.isCancelled(handler)) {
      return null;
    }
    CancellableHandler.sendLoadProgressDetail(handler,R.string.cache_dialog_loading_details_status_waypoints);
    String wpList=page.substring(wpBegin);
    int wpEnd=wpList.indexOf("</p>");
    if (wpEnd > -1 && wpEnd <= wpList.length()) {
      wpList=wpList.substring(0,wpEnd);
    }
    if (!wpList.contains("No additional waypoints to display.")) {
      wpEnd=wpList.indexOf("</table>");
      wpList=wpList.substring(0,wpEnd);
      wpBegin=wpList.indexOf("<tbody>");
      wpEnd=wpList.indexOf("</tbody>");
      if (wpBegin >= 0 && wpEnd >= 0 && wpEnd <= wpList.length()) {
        wpList=wpList.substring(wpBegin + 7,wpEnd);
      }
      final String[] wpItems=StringUtils.splitByWholeSeparator(wpList,"<tr");
      for (int j=1; j < wpItems.length; j++) {
        String[] wp=StringUtils.splitByWholeSeparator(wpItems[j],"<td");
        final String name=TextUtils.getMatch(wp[6],GCConstants.PATTERN_WPNAME,true,1,CgeoApplication.getInstance().getString(R.string.waypoint),true);
        final String resulttype=TextUtils.getMatch(wp[3],GCConstants.PATTERN_WPTYPE,null);
        final Waypoint waypoint=new Waypoint(name,WaypointType.findById(resulttype),false);
        waypoint.setPrefix(TextUtils.getMatch(wp[4],GCConstants.PATTERN_WPPREFIXORLOOKUPORLATLON,true,2,waypoint.getPrefix(),false));
        waypoint.setLookup(TextUtils.getMatch(wp[5],GCConstants.PATTERN_WPPREFIXORLOOKUPORLATLON,true,2,waypoint.getLookup(),false));
        latlon=Html.fromHtml(TextUtils.getMatch(wp[7],GCConstants.PATTERN_WPPREFIXORLOOKUPORLATLON,false,2,"",false)).toString().trim();
        if (!StringUtils.startsWith(latlon,"???")) {
          waypoint.setLatlon(latlon);
          waypoint.setCoords(new Geopoint(latlon));
        }
        j++;
        if (wpItems.length > j) {
          wp=StringUtils.splitByWholeSeparator(wpItems[j],"<td");
        }
        waypoint.setNote(TextUtils.getMatch(wp[3],GCConstants.PATTERN_WPNOTE,waypoint.getNote()));
        cache.addOrChangeWaypoint(waypoint,false);
      }
    }
  }
  cache.parseWaypointsFromNote();
  if (StringUtils.isBlank(cache.getGeocode())) {
    return ImmutablePair.of(StatusCode.UNKNOWN_ERROR,null);
  }
  cache.setDetailedUpdatedNow();
  return ImmutablePair.of(StatusCode.NO_ERROR,cache);
}
