{
  if (StringUtils.isBlank(url) || isCounter(url)) {
    return null;
  }
  final File file=LocalStorage.getStorageFile(geocode,url,true);
  final File fileSec=LocalStorage.getStorageSecFile(geocode,url,true);
  Bitmap imagePre=null;
  if (!onlySave) {
    try {
      imagePre=loadCachedImage(file);
      if (imagePre == null) {
        imagePre=loadCachedImage(fileSec);
      }
    }
 catch (    Exception e) {
      Log.w(Settings.tag,"cgHtmlImg.getDrawable (reading cache): " + e.toString());
    }
  }
  if (imagePre == null || onlySave) {
    final String absoluteURL=makeAbsoluteURL(url);
    BufferedHttpEntity bufferedEntity=null;
    if (absoluteURL != null) {
      try {
        final HttpResponse httpResponse=cgBase.request(absoluteURL,null,false);
        if (httpResponse != null) {
          bufferedEntity=new BufferedHttpEntity(httpResponse.getEntity());
          setSampleSize(bufferedEntity.getContentLength());
          final InputStream is=bufferedEntity.getContent();
          try {
            imagePre=BitmapFactory.decodeStream(is,null,bfOptions);
          }
  finally {
            is.close();
          }
        }
      }
 catch (      Exception e) {
        Log.e(Settings.tag,"cgHtmlImg.getDrawable (downloading from web)",e);
      }
    }
    if (save) {
      LocalStorage.saveEntityToFile(bufferedEntity,file);
    }
  }
  if (onlySave) {
    return null;
  }
  if (imagePre == null) {
    Log.d(Settings.tag,"cgHtmlImg.getDrawable: Failed to obtain image");
    if (placement) {
      imagePre=BitmapFactory.decodeResource(context.getResources(),R.drawable.image_not_loaded);
    }
 else {
      imagePre=BitmapFactory.decodeResource(context.getResources(),R.drawable.image_no_placement);
    }
  }
  final int imgWidth=imagePre.getWidth();
  final int imgHeight=imagePre.getHeight();
  int width;
  int height;
  if (imgWidth > maxWidth || imgHeight > maxHeight) {
    double ratio;
    if ((maxWidth / imgWidth) > (maxHeight / imgHeight)) {
      ratio=(double)maxHeight / (double)imgHeight;
    }
 else {
      ratio=(double)maxWidth / (double)imgWidth;
    }
    width=(int)Math.ceil(imgWidth * ratio);
    height=(int)Math.ceil(imgHeight * ratio);
    try {
      imagePre=Bitmap.createScaledBitmap(imagePre,width,height,true);
    }
 catch (    Exception e) {
      Log.d(Settings.tag,"cgHtmlImg.getDrawable: Failed to scale image");
      return null;
    }
  }
 else {
    width=imgWidth;
    height=imgHeight;
  }
  final BitmapDrawable image=new BitmapDrawable(imagePre);
  image.setBounds(new Rect(0,0,width,height));
  return image;
}
