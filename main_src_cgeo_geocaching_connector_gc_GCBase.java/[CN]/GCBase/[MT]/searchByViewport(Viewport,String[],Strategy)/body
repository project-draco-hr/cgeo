{
  Log.d("GCBase.searchByViewport" + viewport.toString());
  String referer=GCConstants.URL_LIVE_MAP;
  final SearchResult searchResult=new SearchResult();
  searchResult.setUrl(referer + "?ll=" + viewport.getCenter().getLatitude()+ ","+ viewport.getCenter().getLongitude());
  if (strategy.flags.contains(StrategyFlag.LOAD_TILES)) {
    final Set<Tile> tiles=getTilesForViewport(viewport);
    for (    Tile tile : tiles) {
      if (!tileCache.containsKey(tile.hashCode())) {
        final Parameters params=new Parameters("x",String.valueOf(tile.getX()),"y",String.valueOf(tile.getY()),"z",String.valueOf(tile.getZoomlevel()),"ep","1");
        if (tokens != null) {
          params.put("k",tokens[0],"st",tokens[1]);
        }
        if (Settings.isExcludeMyCaches()) {
          params.put("hf","1","hh","1");
        }
        if (Settings.getCacheType() == CacheType.TRADITIONAL) {
          params.put("ect","9,5,3,6,453,13,1304,137,11,4,8,1858");
        }
 else         if (Settings.getCacheType() == CacheType.MULTI) {
          params.put("ect","9,5,2,6,453,13,1304,137,11,4,8,1858");
        }
 else         if (Settings.getCacheType() == CacheType.MYSTERY) {
          params.put("ect","9,5,3,6,453,13,1304,137,11,4,2,1858");
        }
        if (tile.getZoomlevel() != 14) {
          params.put("_",String.valueOf(System.currentTimeMillis()));
        }
        Bitmap bitmap=Tile.requestMapTile(GCConstants.URL_MAP_TILE,params,referer);
        if (bitmap.getWidth() != Tile.TILE_SIZE || bitmap.getHeight() != Tile.TILE_SIZE) {
          bitmap.recycle();
          bitmap=null;
        }
        String data=Tile.requestMapInfo(GCConstants.URL_MAP_INFO,params,referer);
        if (StringUtils.isEmpty(data)) {
          Log.e("GCBase.searchByViewport: No data from server for tile (" + tile.getX() + "/"+ tile.getY()+ ")");
        }
 else {
          final SearchResult search=parseMapJSON(data,tile,bitmap,strategy);
          if (search == null || CollectionUtils.isEmpty(search.getGeocodes())) {
            Log.e("GCBase.searchByViewport: No cache parsed for viewport " + viewport);
          }
 else {
            searchResult.addGeocodes(search.getGeocodes());
          }
          tileCache.put(tile.hashCode(),tile);
        }
        if (bitmap != null) {
          bitmap.recycle();
        }
      }
    }
  }
  if (strategy.flags.contains(StrategyFlag.SEARCH_NEARBY) && Settings.isPremiumMember()) {
    Geopoint center=viewport.getCenter();
    if ((lastSearchViewport == null) || !lastSearchViewport.contains(center)) {
      SearchResult search=cgBase.searchByCoords(null,center,Settings.getCacheType(),false);
      if (search != null && !search.isEmpty()) {
        final Set<String> geocodes=search.getGeocodes();
        lastSearchViewport=cgeoapplication.getInstance().getBounds(geocodes);
        searchResult.addGeocodes(geocodes);
      }
    }
  }
  return searchResult;
}
