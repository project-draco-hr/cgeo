{
  super.onCreate(savedInstanceState);
  res=this.getResources();
  activity=this.getActivity();
  app=(cgeoapplication)activity.getApplication();
  app.setAction(null);
  settings=new cgSettings(activity,activity.getSharedPreferences(cgSettings.preferences,0));
  base=new cgBase(app,settings,activity.getSharedPreferences(cgSettings.preferences,0));
  prefsEdit=activity.getSharedPreferences(cgSettings.preferences,0).edit();
  MapFactory mapFactory=settings.getMapFactory();
  noMapTokenShowed=false;
  activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
  ActivityMixin.setTheme(activity);
  activity.setContentView(settings.getMapFactory().getMapLayoutId());
  ActivityMixin.setTitle(activity,res.getString(R.string.map_map));
  if (geo == null) {
    geo=app.startGeo(activity,geoUpdate,base,settings,0,0);
  }
  if (settings.useCompass == 1 && dir == null) {
    dir=app.startDir(activity,dirUpdate);
  }
  mapView=(MapViewImpl)activity.findViewById(mapFactory.getMapViewId());
  mapView.setMapSource(settings);
  if (!mapView.needsScaleOverlay()) {
    mapView.setBuiltinScale(true);
  }
  mapView.setBuiltInZoomControls(true);
  mapView.displayZoomControls(true);
  mapView.preLoad();
  mapView.clearOverlays();
  if (overlayMyLoc == null) {
    overlayMyLoc=mapView.createAddPositionOverlay(activity,settings);
  }
  if (settings.publicLoc > 0 && overlayUsers == null) {
    overlayUsers=mapView.createAddUsersOverlay(activity,getResources().getDrawable(R.drawable.user_location));
  }
  if (overlayCaches == null) {
    overlayCaches=mapView.createAddMapOverlay(settings,mapView.getContext(),getResources().getDrawable(R.drawable.marker),fromDetailIntent);
  }
  if (overlayScale == null && mapView.needsScaleOverlay()) {
    overlayScale=mapView.createAddScaleOverlay(activity,settings);
  }
  mapView.invalidate();
  mapController=mapView.getMapController();
  mapController.setZoom(settings.mapzoom);
  if (geo != null) {
    geoUpdate.updateLoc(geo);
  }
  if (dir != null) {
    dirUpdate.updateDir(dir);
  }
  Bundle extras=activity.getIntent().getExtras();
  if (extras != null) {
    fromDetailIntent=extras.getBoolean("detail");
    searchIdIntent=extras.getLong("searchid");
    geocodeIntent=extras.getString("geocode");
    latitudeIntent=extras.getDouble("latitude");
    longitudeIntent=extras.getDouble("longitude");
    waypointTypeIntent=extras.getString("wpttype");
    mapStateIntent=extras.getIntArray("mapstate");
    if (searchIdIntent == 0l) {
      searchIdIntent=null;
    }
    if (latitudeIntent == 0.0) {
      latitudeIntent=null;
    }
    if (longitudeIntent == 0.0) {
      longitudeIntent=null;
    }
  }
  if (searchIdIntent == null && geocodeIntent == null && (latitudeIntent == null || longitudeIntent == null)) {
    live=true;
  }
 else {
    live=false;
  }
  if (live) {
    followMyLocation=true;
  }
 else {
    followMyLocation=false;
  }
  if (geocodeIntent != null || searchIdIntent != null || (latitudeIntent != null && longitudeIntent != null) || mapStateIntent != null) {
    centerMap(geocodeIntent,searchIdIntent,latitudeIntent,longitudeIntent,mapStateIntent);
  }
  setMyLoc(null);
  startTimer();
}
