{
  try {
    stop=false;
    working=true;
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    double latMin=(centerLat / 1e6) - ((spanLat / 1e6) / 2) - ((spanLat / 1e6) / 4);
    double latMax=(centerLat / 1e6) + ((spanLat / 1e6) / 2) + ((spanLat / 1e6) / 4);
    double lonMin=(centerLon / 1e6) - ((spanLon / 1e6) / 2) - ((spanLon / 1e6) / 4);
    double lonMax=(centerLon / 1e6) + ((spanLon / 1e6) / 2) + ((spanLon / 1e6) / 4);
    double llCache;
    if (latMin > latMax) {
      llCache=latMax;
      latMax=latMin;
      latMin=llCache;
    }
    if (lonMin > lonMax) {
      llCache=lonMax;
      lonMax=lonMin;
      lonMin=llCache;
    }
    if (token == null) {
      token=base.getMapUserToken(noMapTokenHandler);
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    HashMap<String,String> params=new HashMap<String,String>();
    params.put("usertoken",token);
    params.put("latitude-min",String.format((Locale)null,"%.6f",latMin));
    params.put("latitude-max",String.format((Locale)null,"%.6f",latMax));
    params.put("longitude-min",String.format((Locale)null,"%.6f",lonMin));
    params.put("longitude-max",String.format((Locale)null,"%.6f",lonMax));
    searchId=base.searchByViewport(params,0);
    if (searchId != null) {
      downloaded=true;
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    caches=app.getCaches(searchId,centerLat,centerLon,spanLat,spanLon);
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (displayThread != null && displayThread.isWorking()) {
      displayThread.stopIt();
    }
    displayThread=new DisplayThread(centerLat,centerLon,spanLat,spanLon);
    displayThread.start();
  }
  finally {
    working=false;
  }
}
