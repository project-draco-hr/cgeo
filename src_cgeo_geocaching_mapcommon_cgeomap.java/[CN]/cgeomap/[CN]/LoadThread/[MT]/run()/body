{
  try {
    stop=false;
    working=true;
    loadThreadRun=System.currentTimeMillis();
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (fromDetailIntent) {
      searchId=searchIdIntent;
    }
 else {
      if (!live || settings.maplive == 0) {
        searchId=app.getStoredInViewport(centerLat,centerLon,spanLat,spanLon,settings.cacheType);
      }
 else {
        searchId=app.getCachedInViewport(centerLat,centerLon,spanLat,spanLon,settings.cacheType);
      }
    }
    if (searchId != null) {
      downloaded=true;
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    caches=app.getCaches(searchId);
    if (live && settings.maplive >= 1) {
      int i=0;
      boolean excludeMine=settings.excludeMine > 0;
      boolean excludeDisabled=settings.excludeDisabled > 0;
      while (i < caches.size()) {
        boolean remove=false;
        if ((caches.get(i).found) && (excludeMine))         remove=true;
        if ((caches.get(i).own) && (excludeMine))         remove=true;
        if ((caches.get(i).disabled) && (excludeDisabled))         remove=true;
        if (remove)         caches.remove(i);
 else         i++;
      }
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (displayThread != null && displayThread.isWorking()) {
      displayThread.stopIt();
    }
    displayThread=new DisplayThread(centerLat,centerLon,spanLat,spanLon);
    displayThread.start();
    if (stop) {
      displayThread.stopIt();
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (live && settings.maplive >= 1) {
      if (downloadThread != null && downloadThread.isWorking()) {
        downloadThread.stopIt();
      }
      downloadThread=new DownloadThread(centerLat,centerLon,spanLat,spanLon);
      downloadThread.setName("downloadThread");
      downloadThread.start();
    }
  }
  finally {
    working=false;
  }
}
