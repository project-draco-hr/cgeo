{
  withMockedFilters(new Runnable(){
    @Override public void run(){
      final Strategy strategy=Settings.getLiveMapStrategy();
      final CacheType cacheType=Settings.getCacheType();
      try {
        TestSettings.setExcludeMine(false);
        Settings.setCacheType(CacheType.ALL);
        final GC2CJPF mockedCache=new GC2CJPF();
        deleteCacheFromDB(mockedCache.getGeocode());
        final MapTokens tokens=GCLogin.getInstance().getMapTokens();
        final Viewport viewport=new Viewport(mockedCache,0.003,0.003);
        Settings.setLiveMapStrategy(Strategy.DETAILED);
        SearchResult search=ConnectorFactory.searchByViewport(viewport,tokens);
        assertThat(search).isNotNull();
        assertThat(search.getGeocodes().contains(mockedCache.getGeocode())).isTrue();
        Geocache parsedCache=DataStore.loadCache(mockedCache.getGeocode(),LoadFlags.LOAD_CACHE_OR_DB);
        assert(parsedCache != null);
        assertThat(parsedCache).isNotNull();
        assertThat(mockedCache.getCoords().equals(parsedCache.getCoords())).isEqualTo(Settings.isGCPremiumMember());
        assertThat(parsedCache.isReliableLatLon()).isEqualTo(Settings.isGCPremiumMember());
        Settings.setLiveMapStrategy(Strategy.FAST);
        Tile.cache.removeFromTileCache(mockedCache);
        search=ConnectorFactory.searchByViewport(viewport,tokens);
        assertThat(search).isNotNull();
        assertThat(search.getGeocodes().contains(mockedCache.getGeocode())).isTrue();
        parsedCache=DataStore.loadCache(mockedCache.getGeocode(),LoadFlags.LOAD_CACHE_OR_DB);
        assert(parsedCache != null);
        assertThat(parsedCache).isNotNull();
        assertThat(mockedCache.getCoords().equals(parsedCache.getCoords())).isEqualTo(Settings.isGCPremiumMember());
        assertThat(parsedCache.isReliableLatLon()).isEqualTo(Settings.isGCPremiumMember());
      }
  finally {
        Settings.setLiveMapStrategy(strategy);
        Settings.setCacheType(cacheType);
      }
    }
  }
);
}
