{
  final StringBuilder fieldNoteBuffer=new StringBuilder();
  try {
    int i=0;
    for (    Geocache cache : caches) {
      if (cache.isLogOffline()) {
        appendFieldNote(fieldNoteBuffer,cache,cgData.loadLogOffline(cache.getGeocode()));
        publishProgress(++i);
      }
    }
  }
 catch (  Exception e) {
    Log.e("FieldnoteExport.ExportTask generation",e);
    return false;
  }
  fieldNoteBuffer.append('\n');
  if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
    return false;
  }
  exportLocation.mkdirs();
  SimpleDateFormat fileNameDateFormat=new SimpleDateFormat("yyyyMMddHHmmss",Locale.US);
  exportFile=new File(exportLocation.toString() + '/' + fileNameDateFormat.format(new Date())+ ".txt");
  Writer fw=null;
  try {
    OutputStream os=new FileOutputStream(exportFile);
    fw=new OutputStreamWriter(os,CharEncoding.UTF_16);
    fw.write(fieldNoteBuffer.toString());
  }
 catch (  IOException e) {
    Log.e("FieldnoteExport.ExportTask export",e);
    return false;
  }
 finally {
    IOUtils.closeQuietly(fw);
  }
  if (upload) {
    publishProgress(STATUS_UPLOAD);
    if (!Login.isActualLoginStatus()) {
      final StatusCode loginState=Login.login();
      if (loginState != StatusCode.NO_ERROR) {
        Log.e("FieldnoteExport.ExportTask upload: Login failed");
      }
    }
    final String uri="http://www.geocaching.com/my/uploadfieldnotes.aspx";
    String page=Network.getResponseData(Network.getRequest(uri));
    if (!Login.getLoginStatus(page)) {
      final StatusCode loginState=Login.login();
      if (loginState == StatusCode.NO_ERROR) {
        page=Network.getResponseData(Network.getRequest(uri));
      }
 else {
        Log.e("FieldnoteExport.ExportTask upload: No login (error: " + loginState + ')');
        return false;
      }
    }
    final String[] viewstates=Login.getViewstates(page);
    final Parameters uploadParams=new Parameters("__EVENTTARGET","","__EVENTARGUMENT","","ctl00$ContentBody$btnUpload","Upload Field Note");
    if (onlyNew) {
      uploadParams.put("ctl00$ContentBody$chkSuppressDate","on");
    }
    Login.putViewstates(uploadParams,viewstates);
    Network.getResponseData(Network.postRequest(uri,uploadParams,"ctl00$ContentBody$FieldNoteLoader","text/plain",exportFile));
    if (StringUtils.isBlank(page)) {
      Log.e("FieldnoteExport.ExportTask upload: No data from server");
      return false;
    }
  }
  return true;
}
