{
  final StringBuilder fieldNoteBuffer=new StringBuilder();
  try {
    int i=0;
    for (    cgCache cache : caches) {
      if (cache.isLogOffline()) {
        final LogEntry log=cgeoapplication.getInstance().loadLogOffline(cache.getGeocode());
        fieldNoteBuffer.append(cache.getGeocode()).append(',').append(fieldNoteDateFormat.format(new Date(log.date))).append(',').append(log.type.type).append(",\"").append(StringUtils.replaceChars(log.log,'"','\'')).append("\"\n");
        publishProgress(++i);
      }
    }
  }
 catch (  Exception e) {
    Log.e("FieldnoteExport.ExportTask generation",e);
    return false;
  }
  fieldNoteBuffer.append('\n');
  if (Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
    exportLocation.mkdirs();
    SimpleDateFormat fileNameDateFormat=new SimpleDateFormat("yyyyMMddHHmmss");
    exportFile=new File(exportLocation.toString() + '/' + fileNameDateFormat.format(new Date())+ ".txt");
    OutputStream os;
    Writer fw=null;
    try {
      os=new FileOutputStream(exportFile);
      fw=new OutputStreamWriter(os,"ISO-8859-1");
      fw.write(fieldNoteBuffer.toString());
    }
 catch (    IOException e) {
      Log.e("FieldnoteExport.ExportTask export",e);
      return false;
    }
 finally {
      if (fw != null) {
        try {
          fw.close();
        }
 catch (        IOException e) {
          Log.e("FieldnoteExport.ExportTask export",e);
          return false;
        }
      }
    }
  }
 else {
    return false;
  }
  if (upload) {
    publishProgress(STATUS_UPLOAD);
    final String uri="http://www.geocaching.com/my/uploadfieldnotes.aspx";
    if (!Login.isActualLoginStatus()) {
      final StatusCode loginState=Login.login();
      if (loginState != StatusCode.NO_ERROR) {
        Log.e("FieldnoteExport.ExportTask upload: Login failed");
      }
    }
    String page=Network.getResponseData(Network.getRequest(uri));
    if (!Login.getLoginStatus(page)) {
      final StatusCode loginState=Login.login();
      if (loginState == StatusCode.NO_ERROR) {
        page=Network.getResponseData(Network.getRequest(uri));
      }
 else {
        Log.e("FieldnoteExport.ExportTask upload: No login (error: " + loginState + ')');
        return false;
      }
    }
    final String[] viewstates=Login.getViewstates(page);
    final Parameters uploadParams=new Parameters("__EVENTTARGET","","__EVENTARGUMENT","","ctl00$ContentBody$btnUpload","Upload Field Note");
    if (onlyNew) {
      uploadParams.put("ctl00$ContentBody$chkSuppressDate","on");
    }
    Login.putViewstates(uploadParams,viewstates);
    Network.getResponseData(Network.postRequest(uri,uploadParams,"ctl00$ContentBody$FieldNoteLoader","text/plain",exportFile));
    if (StringUtils.isBlank(page)) {
      Log.e("FieldnoteExport.ExportTask upload: No data from server");
      return false;
    }
  }
  return true;
}
