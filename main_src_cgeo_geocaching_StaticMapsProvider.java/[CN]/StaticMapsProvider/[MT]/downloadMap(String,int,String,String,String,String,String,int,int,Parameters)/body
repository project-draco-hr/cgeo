{
  final Parameters params=new Parameters("center",latlonMap,"zoom",String.valueOf(zoom),"size",String.valueOf(width) + 'x' + String.valueOf(height),"maptype",mapType,"markers","icon:" + markerUrl + '|'+ shadow+ latlonMap,"sensor","false");
  if (waypoints != null) {
    params.addAll(waypoints);
  }
  final HttpResponse httpResponse=Network.getRequest(GOOGLE_STATICMAP_URL,params);
  if (httpResponse == null) {
    Log.e("StaticMapsProvider.downloadMap: httpResponse is null");
    return DownloadState.REQUEST_FAILED;
  }
  if (httpResponse.getStatusLine().getStatusCode() != 200) {
    Log.d("StaticMapsProvider.downloadMap: httpResponseCode = " + httpResponse.getStatusLine().getStatusCode());
    return DownloadState.STATUS_CODE_NOK;
  }
  final File file=getMapFile(geocode,prefix,true);
  if (LocalStorage.saveEntityToFile(httpResponse,file)) {
    final long fileSize=file.length();
    if (fileSize < MIN_MAP_IMAGE_BYTES) {
      file.delete();
      return DownloadState.FILE_TOO_SMALL;
    }
    return DownloadState.OK;
  }
  return DownloadState.NOT_SAVED;
}
