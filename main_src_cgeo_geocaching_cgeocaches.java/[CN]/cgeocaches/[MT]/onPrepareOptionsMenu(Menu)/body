{
  super.onPrepareOptionsMenu(menu);
  try {
    if (adapter.isSelectMode()) {
      menu.findItem(MENU_SWITCH_SELECT_MODE).setTitle(res.getString(R.string.caches_select_mode_exit)).setIcon(R.drawable.ic_menu_clear_playlist);
      menu.findItem(MENU_INVERT_SELECTION).setVisible(true);
    }
 else {
      menu.findItem(MENU_SWITCH_SELECT_MODE).setTitle(res.getString(R.string.caches_select_mode)).setIcon(R.drawable.ic_menu_agenda);
      menu.findItem(MENU_INVERT_SELECTION).setVisible(false);
    }
    final boolean isEmpty=cacheList.isEmpty();
    final boolean isConcrete=isConcreteList();
    setVisible(menu,MENU_SWITCH_SELECT_MODE,!isEmpty);
    setVisible(menu,SUBMENU_MANAGE_HISTORY,!isEmpty);
    setVisible(menu,SUBMENU_SHOW_MAP,!isEmpty);
    setVisible(menu,MENU_SORT,!isEmpty);
    setVisible(menu,MENU_REFRESH_STORED,!isEmpty && (isConcrete || type != CacheListType.OFFLINE));
    setVisible(menu,MENU_DROP_CACHES,!isEmpty);
    setVisible(menu,MENU_DROP_CACHES_AND_LIST,isConcrete && !isEmpty);
    setVisible(menu,MENU_DELETE_EVENTS,isConcrete && !isEmpty && containsEvents());
    setVisible(menu,MENU_MOVE_TO_LIST,!isEmpty);
    setVisible(menu,MENU_EXPORT,!isEmpty);
    setVisible(menu,MENU_REMOVE_FROM_HISTORY,!isEmpty);
    setVisible(menu,MENU_IMPORT_GPX,isConcrete);
    setVisible(menu,MENU_IMPORT_WEB,isConcrete);
    if (navigationMenu != null) {
      navigationMenu.setVisible(!isEmpty);
    }
    final boolean hasSelection=adapter != null && adapter.getCheckedCount() > 0;
    final boolean isNonDefaultList=isConcrete && listId != StoredList.STANDARD_LIST_ID;
    if (type == CacheListType.OFFLINE) {
      setMenuItemLabel(menu,MENU_DROP_CACHES,R.string.caches_drop_selected,R.string.caches_drop_all);
      menu.findItem(MENU_DROP_CACHES_AND_LIST).setVisible(!hasSelection && isNonDefaultList && !adapter.isFiltered());
      setMenuItemLabel(menu,MENU_REFRESH_STORED,R.string.caches_refresh_selected,R.string.caches_refresh_all);
      setMenuItemLabel(menu,MENU_MOVE_TO_LIST,R.string.caches_move_selected,R.string.caches_move_all);
    }
 else {
      setMenuItemLabel(menu,MENU_REFRESH_STORED,R.string.caches_store_selected,R.string.caches_store_offline);
    }
    MenuItem item=menu.findItem(MENU_DROP_LIST);
    if (item != null) {
      item.setVisible(isNonDefaultList);
    }
    item=menu.findItem(MENU_RENAME_LIST);
    if (item != null) {
      item.setVisible(isNonDefaultList);
    }
    final boolean multipleLists=cgData.getLists().size() >= 2;
    item=menu.findItem(MENU_SWITCH_LIST);
    if (item != null) {
      item.setVisible(multipleLists);
    }
    item=menu.findItem(MENU_MOVE_TO_LIST);
    if (item != null) {
      item.setVisible(multipleLists && !isEmpty);
    }
    setMenuItemLabel(menu,MENU_REMOVE_FROM_HISTORY,R.string.cache_remove_from_history,R.string.cache_clear_history);
    setMenuItemLabel(menu,MENU_EXPORT,R.string.export,R.string.export);
  }
 catch (  Exception e) {
    Log.e("cgeocaches.onPrepareOptionsMenu",e);
  }
  return true;
}
