{
  super.onPrepareOptionsMenu(menu);
  try {
    if (adapter != null && adapter.getSelectMode()) {
      menu.findItem(MENU_SWITCH_SELECT_MODE).setTitle(res.getString(R.string.caches_select_mode_exit)).setIcon(R.drawable.ic_menu_clear_playlist);
      menu.findItem(MENU_INVERT_SELECTION).setVisible(true);
    }
 else {
      menu.findItem(MENU_SWITCH_SELECT_MODE).setTitle(res.getString(R.string.caches_select_mode)).setIcon(android.R.drawable.ic_menu_agenda);
      menu.findItem(MENU_INVERT_SELECTION).setVisible(false);
    }
    boolean hasSelection=adapter != null && adapter.getChecked() > 0;
    if (type == CacheListType.OFFLINE) {
      if (hasSelection) {
        menu.findItem(MENU_DROP_CACHES).setTitle(res.getString(R.string.caches_drop_selected) + " (" + adapter.getChecked()+ ")");
      }
 else {
        menu.findItem(MENU_DROP_CACHES).setTitle(res.getString(R.string.caches_drop_all));
      }
      if (hasSelection) {
        menu.findItem(MENU_REFRESH_STORED).setTitle(res.getString(R.string.caches_refresh_selected) + " (" + adapter.getChecked()+ ")");
      }
 else {
        menu.findItem(MENU_REFRESH_STORED).setTitle(res.getString(R.string.caches_refresh_all));
      }
      if (hasSelection) {
        menu.findItem(MENU_MOVE_TO_LIST).setTitle(res.getString(R.string.caches_move_selected) + " (" + adapter.getChecked()+ ")");
      }
 else {
        menu.findItem(MENU_MOVE_TO_LIST).setTitle(res.getString(R.string.caches_move_all));
      }
    }
 else {
      if (hasSelection) {
        menu.findItem(MENU_REFRESH_STORED).setTitle(res.getString(R.string.caches_store_selected) + " (" + adapter.getChecked()+ ")");
      }
 else {
        menu.findItem(MENU_REFRESH_STORED).setTitle(res.getString(R.string.caches_store_offline));
      }
    }
    int[] hideIfEmptyList=new int[]{MENU_SWITCH_SELECT_MODE,SUBMENU_MANAGE_OFFLINE,SUBMENU_MANAGE_HISTORY,SUBMENU_SHOW_MAP,SUBMENU_SORT,MENU_REFRESH_STORED};
    boolean menuEnabled=cacheList.size() > 0;
    for (    int itemId : hideIfEmptyList) {
      MenuItem item=menu.findItem(itemId);
      if (null != item) {
        item.setEnabled(menuEnabled);
      }
    }
    if (navigationMenu != null) {
      navigationMenu.setEnabled(menuEnabled);
    }
    boolean isNonDefaultList=listId != 1;
    MenuItem item=menu.findItem(MENU_DROP_LIST);
    if (item != null) {
      item.setVisible(isNonDefaultList);
    }
    item=menu.findItem(MENU_RENAME_LIST);
    if (item != null) {
      item.setVisible(isNonDefaultList);
    }
    boolean multipleLists=app.getLists().size() >= 2;
    item=menu.findItem(MENU_SWITCH_LIST);
    if (item != null) {
      item.setVisible(multipleLists);
    }
    item=menu.findItem(MENU_MOVE_TO_LIST);
    if (item != null) {
      item.setVisible(multipleLists);
    }
    item=menu.findItem(MENU_REMOVE_FROM_HISTORY);
    if (null != item) {
      if (hasSelection) {
        item.setTitle(res.getString(R.string.cache_remove_from_history) + " (" + adapter.getChecked()+ ")");
      }
 else {
        item.setTitle(res.getString(R.string.cache_clear_history));
      }
    }
    item=menu.findItem(MENU_EXPORT_NOTES);
    if (null != item) {
      if (hasSelection) {
        item.setTitle(res.getString(R.string.cache_export_fieldnote) + " (" + adapter.getChecked()+ ")");
      }
 else {
        item.setTitle(res.getString(R.string.cache_export_fieldnote));
      }
    }
    item=menu.findItem(MENU_EXPORT_NOTES);
    if (null != item) {
      item.setEnabled(false);
      for (      cgCache cache : cacheList) {
        if (cache.isLogOffline()) {
          item.setEnabled(true);
          break;
        }
      }
    }
  }
 catch (  Exception e) {
    Log.e(Settings.tag,"cgeocaches.onPrepareOptionsMenu: " + e.toString());
  }
  return true;
}
