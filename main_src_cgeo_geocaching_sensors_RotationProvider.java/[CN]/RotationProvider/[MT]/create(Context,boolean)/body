{
  final SensorManager sensorManager=(SensorManager)context.getSystemService(Context.SENSOR_SERVICE);
  final Sensor preferredSensor=lowPower ? sensorManager.getDefaultSensor(Sensor.TYPE_GEOMAGNETIC_ROTATION_VECTOR) : null;
  final Sensor rotationSensor=preferredSensor != null ? preferredSensor : sensorManager.getDefaultSensor(Sensor.TYPE_ROTATION_VECTOR);
  if (rotationSensor == null) {
    Log.w("RotationProvider: no rotation sensor on this device");
    return Observable.error(new RuntimeException("no rotation sensor"));
  }
  Log.d(preferredSensor == null ? "RotationProvider: sensor found" : "RotationProvider: geomagnetic (low-power) sensor found");
  final Observable<Float> observable=Observable.create(new OnSubscribe<Float>(){
    private final float[] rotationMatrix=new float[16];
    private final float[] orientation=new float[4];
    private final float[] values=new float[4];
    @Override public void call(    final Subscriber<? super Float> subscriber){
      final SensorEventListener listener=new SensorEventListener(){
        @Override public void onSensorChanged(        final SensorEvent event){
          if (event.values.length > 4) {
            System.arraycopy(event.values,0,values,0,4);
            SensorManager.getRotationMatrixFromVector(rotationMatrix,values);
          }
 else {
            SensorManager.getRotationMatrixFromVector(rotationMatrix,event.values);
          }
          SensorManager.getOrientation(rotationMatrix,orientation);
          subscriber.onNext((float)(orientation[0] * 180 / Math.PI));
        }
        @Override public void onAccuracyChanged(        final Sensor sensor,        final int accuracy){
        }
      }
;
      Log.d("RotationProvider: registering listener");
      sensorManager.registerListener(listener,rotationSensor,SensorManager.SENSOR_DELAY_NORMAL);
      subscriber.add(Subscriptions.create(new Action0(){
        @Override public void call(){
          RxUtils.looperCallbacksWorker.schedule(new Action0(){
            @Override public void call(){
              Log.d("RotationProvider: unregistering listener");
              sensorManager.unregisterListener(listener,rotationSensor);
            }
          }
);
        }
      }
));
    }
  }
);
  return observable.subscribeOn(RxUtils.looperCallbacksScheduler).share().onBackpressureLatest();
}
