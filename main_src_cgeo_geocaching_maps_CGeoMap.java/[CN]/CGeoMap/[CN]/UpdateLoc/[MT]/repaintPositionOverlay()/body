{
  final long currentTimeMillis=System.currentTimeMillis();
  if (currentTimeMillis > timeLastPositionOverlayCalculation + MIN_UPDATE_INTERVAL) {
    timeLastPositionOverlayCalculation=currentTimeMillis;
    try {
      final CGeoMap cgeoMapRef=map.get();
      if (cgeoMapRef != null) {
        if (cgeoMapRef.mapView != null) {
          if (cgeoMapRef.overlayPositionAndScale == null) {
            cgeoMapRef.overlayPositionAndScale=cgeoMapRef.mapView.createAddPositionAndScaleOverlay();
          }
          final boolean needsRepaintForDistance=needsRepaintForDistance();
          final boolean needsRepaintForHeading=needsRepaintForHeading();
          if (needsRepaintForDistance) {
            if (cgeoMapRef.followMyLocation) {
              cgeoMapRef.centerMap(new Geopoint(currentLocation));
            }
          }
          if (needsRepaintForDistance || needsRepaintForHeading) {
            cgeoMapRef.overlayPositionAndScale.setCoordinates(currentLocation);
            cgeoMapRef.overlayPositionAndScale.setHeading(currentHeading);
            cgeoMapRef.mapView.repaintRequired(cgeoMapRef.overlayPositionAndScale);
          }
        }
      }
    }
 catch (    final RuntimeException e) {
      Log.w("Failed to update location.");
    }
  }
}
