{
  try {
    stop=false;
    working=true;
    if (mapView == null || caches == null) {
      displayHandler.sendEmptyMessage(UPDATE_TITLE);
      working=false;
      return;
    }
    final List<cgCache> cachesProtected=new ArrayList<cgCache>(caches);
    final List<CachesOverlayItemImpl> items=new ArrayList<CachesOverlayItemImpl>();
    if (!cachesProtected.isEmpty()) {
      for (      cgCache cacheOne : cachesProtected) {
        if (stop) {
          displayHandler.sendEmptyMessage(UPDATE_TITLE);
          working=false;
          return;
        }
        if (cacheOne.getCoords() == null) {
          continue;
        }
        if (cacheOne.hasWaypoints() && (cachesProtected.size() == 1 || (cachesProtected.size() < Settings.getWayPointsThreshold()))) {
          for (          cgWaypoint oneWaypoint : cacheOne.getWaypoints()) {
            if (oneWaypoint.getCoords() == null) {
              continue;
            }
            items.add(getWaypointItem(new cgCoord(oneWaypoint),oneWaypoint.getWaypointType()));
          }
        }
        items.add(getCacheItem(new cgCoord(cacheOne),cacheOne.getType(),cacheOne.isOwn(),cacheOne.isFound(),cacheOne.isDisabled()));
      }
      overlayCaches.updateItems(items);
      displayHandler.sendEmptyMessage(INVALIDATE_MAP);
      cachesCnt=cachesProtected.size();
      if (stop) {
        displayHandler.sendEmptyMessage(UPDATE_TITLE);
        working=false;
        return;
      }
    }
 else {
      overlayCaches.updateItems(items);
      displayHandler.sendEmptyMessage(INVALIDATE_MAP);
    }
    cachesProtected.clear();
    displayHandler.sendEmptyMessage(UPDATE_TITLE);
  }
  finally {
    working=false;
  }
}
