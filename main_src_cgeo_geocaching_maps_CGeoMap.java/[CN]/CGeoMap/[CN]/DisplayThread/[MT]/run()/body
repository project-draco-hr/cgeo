{
  try {
    stop=false;
    working=true;
    if (mapView == null || caches == null) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    final List<cgCache> cachesProtected=new ArrayList<cgCache>(caches);
    final List<CachesOverlayItemImpl> items=new ArrayList<CachesOverlayItemImpl>();
    if (!cachesProtected.isEmpty()) {
      int icon=0;
      Drawable pin=null;
      CachesOverlayItemImpl item=null;
      for (      cgCache cacheOne : cachesProtected) {
        if (stop) {
          displayHandler.sendEmptyMessage(0);
          working=false;
          return;
        }
        if (cacheOne.coords == null) {
          continue;
        }
        final cgCoord coord=new cgCoord(cacheOne);
        coordinates.add(coord);
        item=settings.getMapFactory().getCachesOverlayItem(coord,cacheOne.type);
        icon=cgBase.getMarkerIcon(true,cacheOne.type,cacheOne.own,cacheOne.found,cacheOne.disabled || cacheOne.archived);
        pin=null;
        if (iconsCache.containsKey(icon)) {
          pin=iconsCache.get(icon);
        }
 else {
          pin=getResources().getDrawable(icon);
          pin.setBounds(0,0,pin.getIntrinsicWidth(),pin.getIntrinsicHeight());
          iconsCache.put(icon,pin);
        }
        item.setMarker(pin);
        items.add(item);
      }
      overlayCaches.updateItems(items);
      displayHandler.sendEmptyMessage(1);
      cachesCnt=cachesProtected.size();
      if (stop) {
        displayHandler.sendEmptyMessage(0);
        working=false;
        return;
      }
      if (cachesCnt == 1 && (geocodeIntent != null || searchIdIntent != null) && !live) {
        if (cachesCnt == 1 && live == false) {
          cgCache oneCache=cachesProtected.get(0);
          if (oneCache != null && oneCache.waypoints != null && !oneCache.waypoints.isEmpty()) {
            for (            cgWaypoint oneWaypoint : oneCache.waypoints) {
              if (oneWaypoint.coords == null) {
                continue;
              }
              cgCoord coord=new cgCoord(oneWaypoint);
              coordinates.add(coord);
              item=settings.getMapFactory().getCachesOverlayItem(coord,null);
              icon=cgBase.getMarkerIcon(false,oneWaypoint.type,false,false,false);
              if (iconsCache.containsKey(icon)) {
                pin=iconsCache.get(icon);
              }
 else {
                pin=getResources().getDrawable(icon);
                pin.setBounds(0,0,pin.getIntrinsicWidth(),pin.getIntrinsicHeight());
                iconsCache.put(icon,pin);
              }
              item.setMarker(pin);
              items.add(item);
            }
            overlayCaches.updateItems(items);
            displayHandler.sendEmptyMessage(1);
          }
        }
      }
    }
 else {
      overlayCaches.updateItems(items);
      displayHandler.sendEmptyMessage(1);
    }
    cachesProtected.clear();
    displayHandler.sendEmptyMessage(0);
  }
  finally {
    working=false;
  }
}
