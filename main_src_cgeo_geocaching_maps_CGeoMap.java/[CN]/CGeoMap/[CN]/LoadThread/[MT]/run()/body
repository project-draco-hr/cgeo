{
  try {
    stop=false;
    working=true;
    loadThreadRun=System.currentTimeMillis();
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (fromDetailIntent || searchIntent != null) {
      search=searchIntent;
    }
 else {
      if (!live || !Settings.isLiveMap()) {
        search=app.getStoredInViewport(centerLat,centerLon,spanLat,spanLon,Settings.getCacheType());
      }
 else {
        search=app.getCachedInViewport(centerLat,centerLon,spanLat,spanLon,Settings.getCacheType());
      }
    }
    if (search != null) {
      downloaded=true;
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    caches=app.getCaches(search,true);
    if (live && Settings.isLiveMap()) {
      final boolean excludeMine=Settings.isExcludeMyCaches();
      final boolean excludeDisabled=Settings.isExcludeDisabledCaches();
      for (int i=caches.size() - 1; i >= 0; i--) {
        cgCache cache=caches.get(i);
        if ((cache.found && excludeMine) || (cache.own && excludeMine) || (cache.disabled && excludeDisabled)) {
          caches.remove(i);
        }
      }
    }
    if (stop) {
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (loadTimer != null) {
      if (loadTimer.getDisplayThread() != null && loadTimer.getDisplayThread().isWorking()) {
        loadTimer.getDisplayThread().stopIt();
      }
    }
    loadTimer.setDisplayThread(new DisplayThread(centerLat,centerLon,spanLat,spanLon));
    loadTimer.getDisplayThread().start();
    if (stop) {
      loadTimer.getDisplayThread().stopIt();
      displayHandler.sendEmptyMessage(0);
      working=false;
      return;
    }
    if (live && Settings.isLiveMap()) {
      if (loadTimer != null) {
        if (loadTimer.getDownloadThread() != null && loadTimer.getDownloadThread().isWorking()) {
          loadTimer.getDownloadThread().stopIt();
        }
        loadTimer.setDownloadThread(new DownloadThread(centerLat,centerLon,spanLat,spanLon));
        loadTimer.getDownloadThread().setName("downloadThread");
        loadTimer.getDownloadThread().start();
      }
    }
  }
  finally {
    working=false;
  }
}
