{
  try {
    stop=false;
    working=true;
    loadThreadRun=System.currentTimeMillis();
    if (stop) {
      displayHandler.sendEmptyMessage(UPDATE_TITLE);
      working=false;
      return;
    }
    if (fromDetailIntent || searchIntent != null || geocodeIntent != null) {
      search=new SearchResult(searchIntent);
      if (geocodeIntent != null) {
        search.addGeocode(geocodeIntent);
      }
    }
 else {
      if (!live || !Settings.isLiveMap()) {
        search=new SearchResult(app.getStoredInViewport(centerLat,centerLon,spanLat,spanLon,Settings.getCacheType()));
      }
 else {
        search=new SearchResult(app.getCachedInViewport(centerLat,centerLon,spanLat,spanLon,Settings.getCacheType()));
      }
    }
    if (search != null) {
      downloaded=true;
    }
    if (stop) {
      displayHandler.sendEmptyMessage(UPDATE_TITLE);
      working=false;
      return;
    }
    caches.addAll(search.getCachesFromSearchResult(LoadFlags.LOAD_WAYPOINTS));
    if (live && Settings.isLiveMap()) {
      final boolean excludeMine=Settings.isExcludeMyCaches();
      final boolean excludeDisabled=Settings.isExcludeDisabledCaches();
      final ArrayList<cgCache> tempList=new ArrayList<cgCache>(caches);
      for (      cgCache cache : tempList) {
        if ((cache.isFound() && excludeMine) || (cache.isOwn() && excludeMine) || (cache.isDisabled() && excludeDisabled)) {
          caches.remove(cache);
        }
      }
    }
    if (stop) {
      displayHandler.sendEmptyMessage(UPDATE_TITLE);
      working=false;
      return;
    }
    if (loadTimer != null) {
      loadTimer.startNewDisplayThread(centerLat,centerLon,spanLat,spanLon);
    }
    if (stop) {
      if (loadTimer != null) {
        loadTimer.stopDisplayThread();
      }
      displayHandler.sendEmptyMessage(UPDATE_TITLE);
      working=false;
      return;
    }
    if (live && Settings.isLiveMap()) {
      if (loadTimer != null) {
        loadTimer.startNewDownloadThread(centerLat,centerLon,spanLat,spanLon);
      }
    }
  }
  finally {
    working=false;
  }
}
