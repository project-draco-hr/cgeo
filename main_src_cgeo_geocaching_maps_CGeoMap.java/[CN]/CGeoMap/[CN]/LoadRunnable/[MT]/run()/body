{
  try {
    showProgressHandler.sendEmptyMessage(SHOW_PROGRESS);
    loadThreadRun=System.currentTimeMillis();
    SearchResult searchResult=null;
    if (mapMode == MapMode.LIVE_ONLINE) {
      searchResult=new SearchResult(app.getStoredInViewport(viewport,Settings.getCacheType()));
    }
 else     if (mapMode == MapMode.LIVE_OFFLINE) {
      searchResult=new SearchResult(app.getCachedInViewport(viewport,Settings.getCacheType()));
    }
 else {
      searchResult=new SearchResult(searchIntent);
      if (geocodeIntent != null) {
        searchResult.addGeocode(geocodeIntent);
      }
    }
    if (searchResult != null) {
      downloaded=true;
      Set<cgCache> cachesFromSearchResult=searchResult.getCachesFromSearchResult(LoadFlags.LOAD_WAYPOINTS);
      caches.addAll(cachesFromSearchResult);
    }
    if (isLiveMode()) {
      final boolean excludeMine=Settings.isExcludeMyCaches();
      final boolean excludeDisabled=Settings.isExcludeDisabledCaches();
      final List<cgCache> tempList=caches.getAsList();
      for (      cgCache cache : tempList) {
        if ((cache.isFound() && excludeMine) || (cache.isOwn() && excludeMine) || (cache.isDisabled() && excludeDisabled)) {
          caches.remove(cache);
        }
      }
    }
    countVisibleCaches();
    if (cachesCnt < Settings.getWayPointsThreshold() || geocodeIntent != null) {
      waypoints.clear();
      if (isLiveMode() || mapMode == MapMode.COORDS) {
        waypoints.addAll(app.getWaypointsInViewport(viewport,Settings.isExcludeMyCaches(),Settings.isExcludeDisabledCaches()));
      }
 else {
        for (        cgCache c : caches.getAsList()) {
          waypoints.addAll(c.getWaypoints());
        }
      }
    }
    displayExecutor.execute(new DisplayRunnable(viewport));
    if (mapMode == MapMode.LIVE_ONLINE) {
      downloadExecutor.execute(new DownloadRunnable(viewport));
    }
    lastSearchResult=searchResult;
  }
  finally {
    showProgressHandler.sendEmptyMessage(HIDE_PROGRESS);
  }
}
