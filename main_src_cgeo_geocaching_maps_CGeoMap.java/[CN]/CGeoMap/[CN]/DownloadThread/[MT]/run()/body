{
  try {
    working=true;
    double lat1=(centerLat / 1e6) - ((spanLat / 1e6) / 2) - ((spanLat / 1e6) / 4);
    double lat2=(centerLat / 1e6) + ((spanLat / 1e6) / 2) + ((spanLat / 1e6) / 4);
    double lon1=(centerLon / 1e6) - ((spanLon / 1e6) / 2) - ((spanLon / 1e6) / 4);
    double lon2=(centerLon / 1e6) + ((spanLon / 1e6) / 2) + ((spanLon / 1e6) / 4);
    double latMin=Math.min(lat1,lat2);
    double latMax=Math.max(lat1,lat2);
    double lonMin=Math.min(lon1,lon2);
    double lonMax=Math.max(lon1,lon2);
    int count=0;
    do {
      if (stop) {
        throw new ThreadDeath();
      }
      if (token == null) {
        token=cgBase.getMapUserToken(noMapTokenHandler);
      }
      if (stop) {
        throw new ThreadDeath();
      }
      final Viewport viewport=new Viewport(new Geopoint(latMin,lonMin),new Geopoint(latMax,lonMax));
      search=cgBase.searchByViewport(token,viewport);
      if (search != null) {
        downloaded=true;
        if (search.error == StatusCode.NOT_LOGGED_IN) {
          cgBase.login();
          token=null;
        }
 else {
          break;
        }
      }
      count++;
    }
 while (count < 2);
    if (stop) {
      throw new ThreadDeath();
    }
    if (search != null) {
      caches.addAll(search.getCachesFromSearchResult(LoadFlags.LOADCACHEORDB));
    }
    if (stop) {
      throw new ThreadDeath();
    }
    if (loadTimer != null) {
      loadTimer.startNewDisplayThread(centerLat,centerLon,spanLat,spanLon);
    }
  }
 catch (  ThreadDeath e) {
    Log.d(Settings.tag,"DownloadThread stopped");
    displayHandler.sendEmptyMessage(UPDATE_TITLE);
  }
 finally {
    stop=false;
    working=false;
  }
}
