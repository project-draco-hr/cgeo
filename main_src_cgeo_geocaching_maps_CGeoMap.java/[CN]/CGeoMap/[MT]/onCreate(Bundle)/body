{
  super.onCreate(savedInstanceState);
  res=this.getResources();
  activity=this.getActivity();
  app=(cgeoapplication)activity.getApplication();
  int countBubbleCnt=app.getAllStoredCachesCount(true,CacheType.ALL);
  caches=new LeastRecentlyUsedSet<cgCache>(MAX_CACHES + countBubbleCnt);
  final MapProvider mapProvider=Settings.getMapProvider();
  mapItemFactory=mapProvider.getMapItemFactory();
  final Bundle extras=activity.getIntent().getExtras();
  if (extras != null) {
    mapMode=(MapMode)extras.get(EXTRAS_MAP_MODE);
    searchIntent=(SearchResult)extras.getParcelable(EXTRAS_SEARCH);
    geocodeIntent=extras.getString(EXTRAS_GEOCODE);
    coordsIntent=(Geopoint)extras.getParcelable(EXTRAS_COORDS);
    waypointTypeIntent=WaypointType.findById(extras.getString(EXTRAS_WPTTYPE));
    mapStateIntent=extras.getIntArray(EXTRAS_MAPSTATE);
    mapTitle=extras.getString(EXTRAS_MAP_TITLE);
    Settings.setLiveMap(mapMode == MapMode.LIVE_ONLINE ? true : false);
  }
 else {
    mapMode=Settings.isLiveMap() ? MapMode.LIVE_ONLINE : MapMode.LIVE_OFFLINE;
  }
  if (StringUtils.isBlank(mapTitle)) {
    mapTitle=res.getString(R.string.map_map);
  }
  if (savedInstanceState != null) {
    currentSourceId=savedInstanceState.getInt(BUNDLE_MAP_SOURCE,Settings.getMapSource());
    mapStateIntent=savedInstanceState.getIntArray(BUNDLE_MAP_STATE);
  }
 else {
    currentSourceId=Settings.getMapSource();
  }
  if (changeMapSource(Settings.getMapSource())) {
    return;
  }
  noMapTokenShowed=false;
  ActivityMixin.keepScreenOn(activity,true);
  ActivityMixin.setTheme(activity);
  activity.setContentView(mapProvider.getMapLayoutId());
  ActivityMixin.setTitle(activity,res.getString(R.string.map_map));
  mapView=(MapViewImpl)activity.findViewById(mapProvider.getMapViewId());
  mapView.setMapSource();
  mapView.setBuiltInZoomControls(true);
  mapView.displayZoomControls(true);
  mapView.preLoad();
  mapView.setOnDragListener(this);
  mapView.clearOverlays();
  if (Settings.isPublicLoc() && overlayGo4Cache == null) {
    overlayGo4Cache=mapView.createAddUsersOverlay(activity,getResources().getDrawable(R.drawable.user_location));
  }
  if (overlayCaches == null) {
    overlayCaches=mapView.createAddMapOverlay(mapView.getContext(),getResources().getDrawable(R.drawable.marker));
  }
  if (overlayPosition == null) {
    overlayPosition=mapView.createAddPositionOverlay(activity);
  }
  if (overlayScale == null) {
    overlayScale=mapView.createAddScaleOverlay(activity);
  }
  mapView.repaintRequired(null);
  mapView.getMapController().setZoom(Settings.getMapZoom());
  mapView.getMapController().setCenter(Settings.getMapCenter());
  if (null == mapStateIntent) {
    followMyLocation=mapMode == MapMode.LIVE_OFFLINE || mapMode == MapMode.LIVE_ONLINE;
  }
 else {
    followMyLocation=1 == mapStateIntent[3];
    if ((overlayCaches.getCircles() ? 1 : 0) != mapStateIntent[4]) {
      overlayCaches.switchCircles();
    }
  }
  if (geocodeIntent != null || searchIntent != null || coordsIntent != null || mapStateIntent != null) {
    centerMap(geocodeIntent,searchIntent,coordsIntent,mapStateIntent);
  }
  myLocSwitch=(ImageSwitcher)activity.findViewById(R.id.my_position);
  myLocSwitch.setFactory(this);
  myLocSwitch.setInAnimation(activity,android.R.anim.fade_in);
  myLocSwitch.setOutAnimation(activity,android.R.anim.fade_out);
  myLocSwitch.setOnClickListener(new MyLocationListener());
  switchMyLocationButton();
  prepareFilterBar();
  if (!app.isLiveMapHintShown() && !Settings.getHideLiveMapHint()) {
    Intent hintIntent=new Intent(activity,LiveMapInfo.class);
    activity.startActivity(hintIntent);
    app.setLiveMapHintShown();
  }
}
