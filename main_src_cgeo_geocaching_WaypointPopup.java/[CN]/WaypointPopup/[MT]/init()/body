{
  app.setAction(geocode);
  cache=app.loadCache(geocode,LoadFlags.LOAD_CACHE_OR_DB);
  waypoint=app.loadWaypoint(waypoint_id);
  if (cache == null) {
    showToast(res.getString(R.string.err_detail_cache_find));
    finish();
    return;
  }
  if (CacheType.UNKNOWN == cache.getType()) {
    Set<String> geocodes=new HashSet<String>();
    geocodes.add(geocode);
    SearchResult search=ConnectorFactory.searchByGeocodes(geocodes);
    cache=search.getFirstCacheFromResult(LoadFlags.LOAD_CACHE_ONLY);
  }
  try {
    RelativeLayout itemLayout;
    TextView itemName;
    TextView itemValue;
    LinearLayout itemStars;
    if (StringUtils.isNotBlank(waypoint.getName())) {
      setTitle(waypoint.getName());
    }
 else {
      setTitle(waypoint.getGeocode().toUpperCase());
    }
    inflater=getLayoutInflater();
    geocode=cache.getGeocode().toUpperCase();
    ((TextView)findViewById(R.id.actionbar_title)).setCompoundDrawablesWithIntrinsicBounds(getResources().getDrawable(waypoint.getWaypointType().markerId),null,null,null);
    LinearLayout waypointDetailsList=(LinearLayout)findViewById(R.id.waypoint_details_list);
    waypointDetailsList.removeAllViews();
    itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
    itemName=(TextView)itemLayout.findViewById(R.id.name);
    itemValue=(TextView)itemLayout.findViewById(R.id.value);
    itemName.setText(res.getString(R.string.cache_geocode));
    itemValue.setText(waypoint.getPrefix().toUpperCase() + waypoint.getGeocode().toUpperCase().substring(2));
    waypointDetailsList.addView(itemLayout);
    Button buttonEdit=(Button)findViewById(R.id.edit);
    buttonEdit.setOnClickListener(new OnClickListener(){
      public void onClick(      View arg0){
        Intent editIntent=new Intent(WaypointPopup.this,cgeowaypointadd.class);
        editIntent.putExtra("waypoint",waypoint.getId());
        startActivity(editIntent);
        restartActivity();
      }
    }
);
    LinearLayout cacheDetailsList=(LinearLayout)findViewById(R.id.cache_details_list);
    cacheDetailsList.removeAllViews();
    itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
    itemName=(TextView)itemLayout.findViewById(R.id.name);
    itemValue=(TextView)itemLayout.findViewById(R.id.value);
    itemValue.setLines(1);
    itemName.setText(res.getString(R.string.cache_name));
    itemValue.setText(cache.getName());
    cacheDetailsList.addView(itemLayout);
    itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
    itemName=(TextView)itemLayout.findViewById(R.id.name);
    itemValue=(TextView)itemLayout.findViewById(R.id.value);
    itemName.setText(res.getString(R.string.cache_type));
    String cacheType=cache.getType().getL10n();
    String cacheSize=cache.getSize() != CacheSize.UNKNOWN ? " (" + cache.getSize().getL10n() + ")" : "";
    itemValue.setText(cacheType + cacheSize);
    cacheDetailsList.addView(itemLayout);
    itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
    itemName=(TextView)itemLayout.findViewById(R.id.name);
    itemValue=(TextView)itemLayout.findViewById(R.id.value);
    itemName.setText(res.getString(R.string.cache_geocode));
    itemValue.setText(cache.getGeocode().toUpperCase());
    cacheDetailsList.addView(itemLayout);
    if (cache.isArchived() || cache.isDisabled() || cache.isPremiumMembersOnly()|| cache.isFound()) {
      itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
      itemName=(TextView)itemLayout.findViewById(R.id.name);
      itemValue=(TextView)itemLayout.findViewById(R.id.value);
      itemName.setText(res.getString(R.string.cache_status));
      final StringBuilder state=new StringBuilder();
      if (cache.isFound()) {
        if (state.length() > 0) {
          state.append(", ");
        }
        state.append(res.getString(R.string.cache_status_found));
      }
      if (cache.isArchived()) {
        if (state.length() > 0) {
          state.append(", ");
        }
        state.append(res.getString(R.string.cache_status_archived));
      }
      if (cache.isDisabled()) {
        if (state.length() > 0) {
          state.append(", ");
        }
        state.append(res.getString(R.string.cache_status_disabled));
      }
      if (cache.isPremiumMembersOnly()) {
        if (state.length() > 0) {
          state.append(", ");
        }
        state.append(res.getString(R.string.cache_status_premium));
      }
      itemValue.setText(state.toString());
      cacheDetailsList.addView(itemLayout);
    }
    itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_item,null);
    itemName=(TextView)itemLayout.findViewById(R.id.name);
    itemValue=(TextView)itemLayout.findViewById(R.id.value);
    itemName.setText(res.getString(R.string.cache_distance));
    itemValue.setText("--");
    cacheDetailsList.addView(itemLayout);
    cacheDistance=itemValue;
    if (cache.getDifficulty() > 0f) {
      itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_layout,null);
      itemName=(TextView)itemLayout.findViewById(R.id.name);
      itemValue=(TextView)itemLayout.findViewById(R.id.value);
      itemStars=(LinearLayout)itemLayout.findViewById(R.id.stars);
      itemName.setText(res.getString(R.string.cache_difficulty));
      itemValue.setText(String.format("%.1f",cache.getDifficulty()) + ' ' + res.getString(R.string.cache_rating_of)+ " 5");
      for (int i=0; i <= 4; i++) {
        ImageView star=(ImageView)inflater.inflate(R.layout.star,null);
        if ((cache.getDifficulty() - i) >= 1.0) {
          star.setImageResource(R.drawable.star_on);
        }
 else         if ((cache.getDifficulty() - i) > 0.0) {
          star.setImageResource(R.drawable.star_half);
        }
 else {
          star.setImageResource(R.drawable.star_off);
        }
        itemStars.addView(star);
      }
      cacheDetailsList.addView(itemLayout);
    }
    if (cache.getTerrain() > 0f) {
      itemLayout=(RelativeLayout)inflater.inflate(R.layout.cache_layout,null);
      itemName=(TextView)itemLayout.findViewById(R.id.name);
      itemValue=(TextView)itemLayout.findViewById(R.id.value);
      itemStars=(LinearLayout)itemLayout.findViewById(R.id.stars);
      itemName.setText(res.getString(R.string.cache_terrain));
      itemValue.setText(String.format("%.1f",cache.getTerrain()) + ' ' + res.getString(R.string.cache_rating_of)+ " 5");
      for (int i=0; i <= 4; i++) {
        ImageView star=(ImageView)inflater.inflate(R.layout.star,null);
        if ((cache.getTerrain() - i) >= 1.0) {
          star.setImageResource(R.drawable.star_on);
        }
 else         if ((cache.getTerrain() - i) > 0.0) {
          star.setImageResource(R.drawable.star_half);
        }
 else {
          star.setImageResource(R.drawable.star_off);
        }
        itemStars.addView(star);
      }
      cacheDetailsList.addView(itemLayout);
    }
    if (cache.getRating() > 0) {
      setRating(cache.getRating(),cache.getVotes());
    }
 else {
      if (Settings.isRatingWanted() && cache.supportsGCVote()) {
        (new Thread(){
          @Override public void run(){
            GCVoteRating rating=GCVote.getRating(cache.getGuid(),geocode);
            if (rating == null) {
              return;
            }
            Message msg=Message.obtain();
            Bundle bundle=new Bundle();
            bundle.putFloat("rating",rating.getRating());
            bundle.putInt("votes",rating.getVotes());
            msg.setData(bundle);
            ratingHandler.sendMessage(msg);
          }
        }
).start();
      }
    }
    Button buttonMore=(Button)findViewById(R.id.more_details);
    buttonMore.setOnClickListener(new OnClickListener(){
      public void onClick(      View arg0){
        Intent cachesIntent=new Intent(WaypointPopup.this,CacheDetailActivity.class);
        cachesIntent.putExtra(EXTRA_GEOCODE,geocode.toUpperCase());
        startActivity(cachesIntent);
        finish();
      }
    }
);
  }
 catch (  Exception e) {
    Log.e("cgeopopup.init: " + e.toString());
  }
}
