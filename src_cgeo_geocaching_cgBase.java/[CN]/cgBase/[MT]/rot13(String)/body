{
  final StringBuilder result=new StringBuilder();
  boolean plaintext=false;
  int length=text.length();
  for (int index=0; index < length; index++) {
    int c=text.charAt(index);
    if (c == '[') {
      plaintext=true;
    }
 else     if (c == ']') {
      plaintext=false;
    }
 else     if (!plaintext) {
      int capitalized=c & 32;
      c&=~capitalized;
      c=((c >= 'A') && (c <= 'Z') ? ((c - 'A' + 13) % 26 + 'A') : c) | capitalized;
    }
    result.append((char)c);
  }
  return result.toString();
}
