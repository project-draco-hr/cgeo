{
  final cgSearch search=new cgSearch();
  final String latMin=parameters.get("latitude-min");
  final String latMax=parameters.get("latitude-max");
  final String lonMin=parameters.get("longitude-min");
  final String lonMax=parameters.get("longitude-max");
  String usertoken=null;
  if (parameters.get("usertoken") != null) {
    usertoken=parameters.get("usertoken");
  }
 else {
    usertoken="";
  }
  cgCacheWrap caches=new cgCacheWrap();
  String page=null;
  if (latMin == null || latMin.length() == 0 || latMax == null || latMax.length() == 0 || lonMin == null || lonMin.length() == 0 || lonMax == null || lonMax.length() == 0) {
    Log.e(cgSettings.tag,"cgeoBase.searchByViewport: Not enough parameters to recognize viewport");
    return null;
  }
  final String host="www.geocaching.com";
  final String path="/map/default.aspx/MapAction";
  String params="{\"dto\":{\"data\":{\"c\":1,\"m\":\"\",\"d\":\"" + latMax + "|"+ latMin+ "|"+ lonMax+ "|"+ lonMin+ "\"},\"ut\":\""+ usertoken+ "\"}}";
  final String url="http://" + host + path+ "?"+ params;
  page=requestJSONgc(host,path,params);
  if (page == null || page.length() == 0) {
    Log.e(cgSettings.tag,"cgeoBase.searchByViewport: No data from server");
    return null;
  }
  caches=parseMapJSON(url,page);
  if (caches == null || caches.cacheList == null || caches.cacheList.isEmpty()) {
    Log.e(cgSettings.tag,"cgeoBase.searchByViewport: No cache parsed");
  }
  if (app == null) {
    Log.e(cgSettings.tag,"cgeoBase.searchByViewport: No application found");
    return null;
  }
  final ArrayList<cgCache> cacheList=new ArrayList<cgCache>();
  if (caches != null) {
    if (caches.error != null && caches.error.length() > 0) {
      search.error=caches.error;
    }
    if (caches.url != null && caches.url.length() > 0) {
      search.url=caches.url;
    }
    if (caches.viewstate != null && caches.viewstate.length() > 0) {
      search.viewstate=caches.viewstate;
    }
    if (caches.viewstate1 != null && caches.viewstate1.length() > 0) {
      search.viewstate1=caches.viewstate1;
    }
    search.totalCnt=caches.totalCnt;
    if (caches.cacheList != null && caches.cacheList.size() > 0) {
      for (      cgCache cache : caches.cacheList) {
        if ((settings.excludeDisabled == 0 || (settings.excludeDisabled == 1 && cache.disabled == false)) && (settings.excludeMine == 0 || (settings.excludeMine == 1 && cache.own == false)) && (settings.excludeMine == 0 || (settings.excludeMine == 1 && cache.found == false))&& (settings.cacheType == null || (settings.cacheType.equals(cache.type)))) {
          search.addGeocode(cache.geocode);
          cacheList.add(cache);
        }
      }
    }
  }
  app.addSearch(search,cacheList,true,reason);
  return search.getCurrentId();
}
