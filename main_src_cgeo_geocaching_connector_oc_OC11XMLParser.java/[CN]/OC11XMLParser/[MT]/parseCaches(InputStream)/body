{
  final Map<String,Geocache> caches=new HashMap<String,Geocache>();
  final Map<String,LogEntry> logs=new HashMap<String,LogEntry>();
  final CacheHolder cacheHolder=new CacheHolder();
  final CacheLog logHolder=new CacheLog();
  final CacheDescription descHolder=new CacheDescription();
  final RootElement root=new RootElement("oc11xml");
  final Element cacheNode=root.getChild("cache");
  cacheNode.setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attributes){
      resetCache(cacheHolder);
    }
  }
);
  cacheNode.setEndElementListener(new EndElementListener(){
    @Override public void end(){
      Geocache cache=cacheHolder.cache;
      Geopoint coords=new Geopoint(cacheHolder.latitude,cacheHolder.longitude);
      cache.setCoords(coords);
      if (caches.size() < CACHE_PARSE_LIMIT && isValid(cache) && !isExcluded(cache)) {
        cache.setDetailedUpdatedNow();
        caches.put(cache.getCacheId(),cache);
      }
    }
    private boolean isExcluded(    Geocache cache){
      if (cache.isArchived() && Settings.isExcludeDisabledCaches()) {
        return true;
      }
      if (cache.isFound() && Settings.isExcludeMyCaches()) {
        return true;
      }
      return !Settings.getCacheType().contains(cache);
    }
    private boolean isValid(    Geocache cache){
      return StringUtils.isNotBlank(cache.getGeocode()) && !cache.getCoords().equals(Geopoint.ZERO);
    }
  }
);
  cacheNode.getChild("id").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      cacheHolder.cache.setCacheId(body);
    }
  }
);
  cacheNode.getChild("longitude").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      String longitude=body.trim();
      if (StringUtils.isNotBlank(longitude)) {
        cacheHolder.longitude=longitude;
      }
    }
  }
);
  cacheNode.getChild("latitude").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      String latitude=body.trim();
      if (StringUtils.isNotBlank(latitude)) {
        cacheHolder.latitude=latitude;
      }
    }
  }
);
  cacheNode.getChild("name").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      cacheHolder.cache.setName(content);
    }
  }
);
  cacheNode.getChild("waypoints").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      if (attrs.getIndex("oc") > -1) {
        cacheHolder.cache.setGeocode(attrs.getValue("oc"));
      }
      if (attrs.getIndex("gccom") > -1) {
        String gccode=attrs.getValue("gccom");
        if (!StringUtils.isBlank(gccode)) {
          cacheHolder.cache.setDescription(res.getString(R.string.cache_listed_on,GCConnector.getInstance().getName()) + ": <a href=\"http://coord.info/" + gccode+ "\">"+ gccode+ "</a><br /><br />");
        }
      }
    }
  }
);
  cacheNode.getChild("type").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      if (attrs.getIndex("id") > -1) {
        final String typeId=attrs.getValue("id");
        cacheHolder.cache.setType(getCacheType(typeId));
      }
    }
  }
);
  cacheNode.getChild("status").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      if (attrs.getIndex("id") > -1) {
        try {
          final int statusId=Integer.parseInt(attrs.getValue("id"));
          setCacheStatus(statusId,cacheHolder.cache);
        }
 catch (        NumberFormatException e) {
          Log.w(String.format("Failed to parse status of cache '%s'.",cacheHolder.cache.getGeocode()));
        }
      }
    }
  }
);
  cacheNode.getChild("size").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      if (attrs.getIndex("id") > -1) {
        final String typeId=attrs.getValue("id");
        cacheHolder.cache.setSize(getCacheSize(typeId));
      }
    }
  }
);
  cacheNode.getChild("difficulty").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      try {
        cacheHolder.cache.setDifficulty(Float.valueOf(content));
      }
 catch (      NumberFormatException e) {
        Log.e("OC11XMLParser: unknown difficulty " + content,e);
      }
    }
  }
);
  cacheNode.getChild("terrain").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      try {
        cacheHolder.cache.setTerrain(Float.valueOf(content));
      }
 catch (      NumberFormatException e) {
        Log.e("OC11XMLParser: unknown terrain " + content,e);
      }
    }
  }
);
  cacheNode.getChild("datehidden").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      cacheHolder.cache.setHidden(parseFullDate(content));
    }
  }
);
  final Element attributeNode=cacheNode.getChild("attributes").getChild("attribute");
  attributeNode.setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attributes){
      if (attributes.getIndex("id") > -1) {
        try {
          attributeId=Integer.parseInt(attributes.getValue("id"));
        }
 catch (        NumberFormatException e) {
          Log.w(String.format("Failed to parse attribute id of cache '%s'.",cacheHolder.cache.getGeocode()));
        }
      }
    }
  }
);
  attributeNode.setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      CacheAttribute attribute=AttributeMapper.getAttribute(attributeId);
      if (attribute != null) {
        cacheHolder.cache.getAttributes().add(attribute.getAttributeName(true));
      }
 else {
        if (StringUtils.isNotBlank(body)) {
          cacheHolder.cache.getAttributes().add(body.trim());
        }
      }
    }
  }
);
  final Element cacheDesc=root.getChild("cachedesc");
  cacheDesc.setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attributes){
      resetDesc(descHolder);
    }
  }
);
  cacheDesc.setEndElementListener(new EndElementListener(){
    @Override public void end(){
      final Geocache cache=caches.get(descHolder.cacheId);
      if (cache != null) {
        cache.setShortdesc(descHolder.shortDesc);
        cache.setDescription(cache.getDescription() + descHolder.desc);
        cache.setHint(descHolder.hint);
      }
    }
  }
);
  cacheDesc.getChild("cacheid").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      descHolder.cacheId=body;
    }
  }
);
  cacheDesc.getChild("shortdesc").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      descHolder.shortDesc=linkify(content);
    }
  }
);
  cacheDesc.getChild("desc").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      final String content=body.trim();
      descHolder.desc=linkify(content);
    }
  }
);
  cacheDesc.getChild("hint").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      descHolder.hint=body.trim();
    }
  }
);
  final Element cacheLog=root.getChild("cachelog");
  cacheLog.setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      resetLog(logHolder);
    }
  }
);
  cacheLog.setEndElementListener(new EndElementListener(){
    @Override public void end(){
      final Geocache cache=caches.get(logHolder.cacheId);
      if (cache != null && logHolder.logEntry.type != LogType.UNKNOWN) {
        logs.put(logHolder.id,logHolder.logEntry);
        cache.getLogs().add(0,logHolder.logEntry);
        if (logHolder.logEntry.type == LogType.FOUND_IT && StringUtils.equalsIgnoreCase(logHolder.logEntry.author,Settings.getOCConnectorUserName())) {
          cache.setFound(true);
          cache.setVisitedDate(logHolder.logEntry.date);
        }
      }
    }
  }
);
  cacheLog.getChild("id").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      logHolder.id=StringUtils.trim(body);
    }
  }
);
  cacheLog.getChild("cacheid").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      logHolder.cacheId=body;
    }
  }
);
  cacheLog.getChild("date").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      try {
        logHolder.logEntry.date=parseDayDate(body).getTime();
      }
 catch (      NullPointerException e) {
        Log.w("Failed to parse log date",e);
      }
    }
  }
);
  cacheLog.getChild("logtype").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      if (attrs.getIndex("id") > -1) {
        final String id=attrs.getValue("id");
        try {
          final int typeId=Integer.parseInt(id);
          logHolder.logEntry.type=getLogType(typeId);
        }
 catch (        NumberFormatException e) {
          Log.e("OC11XMLParser, unknown logtype " + id,e);
        }
      }
    }
  }
);
  cacheLog.getChild("userid").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String finderName){
      logHolder.logEntry.author=finderName;
    }
  }
);
  cacheLog.getChild("text").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String logText){
      logHolder.logEntry.log=stripMarkup(logText);
    }
  }
);
  final Element picture=root.getChild("picture");
  picture.setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attrs){
      imageHolder=new ImageHolder();
    }
  }
);
  picture.setEndElementListener(new EndElementListener(){
    @Override public void end(){
      if (imageHolder.isSpoiler) {
        final Geocache cache=caches.get(imageHolder.objectId);
        if (cache != null) {
          Image spoiler=new Image(imageHolder.url,imageHolder.title);
          cache.addSpoiler(spoiler);
        }
      }
 else {
        final LogEntry log=logs.get(imageHolder.objectId);
        if (log != null) {
          log.addLogImage(new Image(imageHolder.url,imageHolder.title));
        }
      }
    }
  }
);
  picture.getChild("object").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      imageHolder.objectId=StringUtils.trim(body);
    }
  }
);
  picture.getChild("title").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      imageHolder.title=StringUtils.trim(body);
    }
  }
);
  picture.getChild("url").setEndTextElementListener(new EndTextElementListener(){
    @Override public void end(    String body){
      imageHolder.url=StringUtils.trim(body);
    }
  }
);
  picture.getChild("attributes").setStartElementListener(new StartElementListener(){
    @Override public void start(    Attributes attributes){
      if (attributes.getIndex("spoiler") > -1) {
        String spoiler=attributes.getValue("spoiler");
        imageHolder.isSpoiler=("1".equals(spoiler));
      }
    }
  }
);
  try {
    Xml.parse(stream,Xml.Encoding.UTF_8,root.getContentHandler());
    return caches.values();
  }
 catch (  SAXException e) {
    Log.e("Cannot parse .gpx file as oc11xml: could not parse XML",e);
    return null;
  }
}
